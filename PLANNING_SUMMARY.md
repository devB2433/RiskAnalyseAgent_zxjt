# 项目规划总结

## 📋 使用场景确认

**目标用户**: 企业安全团队
**核心需求**:
1. ✅ 集成各类数据源（数据库、API、文件等）
2. ✅ 自动化安全分析（无需人工介入）
3. ✅ 结果持久化存储（所有分析结果和告警记录）
4. ✅ 及时告警通知（飞书、企业微信、邮件）
5. ✅ 无人值守运行

## 🎯 核心功能优先级调整

基于企业场景，我重新调整了优先级，将以下功能提升为P1（最高优先级）：

### 新增P1功能

1. **自动化调度系统** ⭐⭐⭐⭐⭐
   - 定时任务调度（APScheduler + Cron）
   - 数据源自动拉取
   - 分析任务自动触发
   - 失败重试机制
   - 任务执行历史

2. **结果持久化存储** ⭐⭐⭐⭐⭐
   - 数据库设计（分析结果、告警记录、任务历史、IOC记录）
   - SQLite（开发）+ PostgreSQL（生产）
   - 历史查询API
   - 数据归档和清理

3. **告警通知系统** ⭐⭐⭐⭐⭐
   - 飞书机器人集成（Webhook + 富文本卡片）
   - 企业微信机器人集成（Webhook + Markdown）
   - 邮件通知（SMTP + HTML + 附件）
   - 告警规则配置（按严重级别和类型）
   - 告警模板系统
   - 告警去重和聚合

### 原有P1功能

4. **完成安全分析器V2版本** ⭐⭐⭐⭐⭐
   - 5个分析器升级到V2（使用真实威胁情报）

5. **配置管理系统** ⭐⭐⭐⭐⭐
   - YAML配置文件
   - 数据源、调度、告警、威胁情报配置
   - 环境变量支持
   - 配置验证

6. **日志系统** ⭐⭐⭐⭐
   - JSON格式结构化日志
   - 日志轮转
   - 审计日志

7. **测试框架** ⭐⭐⭐⭐
   - pytest测试框架
   - 单元测试和集成测试

## 📅 实施计划（4周）

### 第1周：核心自动化功能
**目标**: 实现自动化调度和结果存储

**任务**:
- P1-1: 自动化调度系统（3-4天）
- P1-2: 结果持久化存储（3-4天）
- P1-5: 配置管理系统（开始）

**里程碑**: 系统能够自动定时拉取数据并执行分析，结果保存到数据库

---

### 第2周：告警通知和分析器完善
**目标**: 实现告警通知和完成所有分析器

**任务**:
- P1-3: 告警通知系统（3-4天）
- P1-4: 完成安全分析器V2版本（2-3天）
- P1-5: 配置管理系统（完成）
- P1-6: 日志系统（2天）

**里程碑**: 系统能够自动发现问题并通知到飞书/企业微信/邮件

---

### 第3周：测试和运维
**目标**: 完善测试和部署工具

**任务**:
- P1-7: 测试框架（3-5天）
- P2-1: 监控指标系统（2-3天）
- P2-2: 部署工具（Docker + 部署脚本）（2-3天）

**里程碑**: 系统具备生产环境部署能力

---

### 第4周：文档和扩展
**目标**: 完善文档和扩展功能

**任务**:
- P2-3: 完善文档（2-3天）
- P3-1: 添加更多威胁情报提供商（2-3个）
- P3-2: 添加更多数据源连接器（1-2个）

**里程碑**: 系统文档完整，可以交付使用

## 🏗️ 系统架构（企业版）

```
┌─────────────────────────────────────────────────────────────┐
│                    企业安全分析系统                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐      ┌──────────────┐                     │
│  │  调度系统    │      │  配置管理    │                     │
│  │ APScheduler  │◄────►│   YAML       │                     │
│  └──────┬───────┘      └──────────────┘                     │
│         │                                                     │
│         ▼                                                     │
│  ┌──────────────────────────────────────┐                   │
│  │         数据接入层                    │                   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐   │                   │
│  │  │Database│ │  API   │ │  File  │   │                   │
│  │  └────────┘ └────────┘ └────────┘   │                   │
│  └──────────────┬───────────────────────┘                   │
│                 │                                             │
│                 ▼                                             │
│  ┌──────────────────────────────────────┐                   │
│  │         安全分析引擎                  │                   │
│  │  ┌────────────┐  ┌────────────┐     │                   │
│  │  │ 8种分析器  │  │ 威胁情报   │     │                   │
│  │  │   (V2)     │◄─┤   集成     │     │                   │
│  │  └────────────┘  └────────────┘     │                   │
│  └──────────────┬───────────────────────┘                   │
│                 │                                             │
│                 ▼                                             │
│  ┌──────────────────────────────────────┐                   │
│  │         结果存储层                    │                   │
│  │  ┌────────────┐  ┌────────────┐     │                   │
│  │  │  分析结果  │  │  告警记录  │     │                   │
│  │  └────────────┘  └────────────┘     │                   │
│  │  ┌────────────┐  ┌────────────┐     │                   │
│  │  │  任务历史  │  │  IOC记录   │     │                   │
│  │  └────────────┘  └────────────┘     │                   │
│  └──────────────┬───────────────────────┘                   │
│                 │                                             │
│                 ▼                                             │
│  ┌──────────────────────────────────────┐                   │
│  │         告警通知层                    │                   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐   │                   │
│  │  │  飞书  │ │企业微信│ │  邮件  │   │                   │
│  │  └────────┘ └────────┘ └────────┘   │                   │
│  └──────────────────────────────────────┘                   │
│                                                               │
│  ┌──────────────────────────────────────┐                   │
│  │         监控与日志                    │                   │
│  │  ┌────────────┐  ┌────────────┐     │                   │
│  │  │  日志系统  │  │  监控指标  │     │                   │
│  │  └────────────┘  └────────────┘     │                   │
│  └──────────────────────────────────────┘                   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技术栈

### 核心技术
- **Python 3.8+**
- **LangChain** - Agent框架
- **APScheduler** - 任务调度
- **SQLAlchemy** - ORM
- **SQLite/PostgreSQL** - 数据库
- **pytest** - 测试框架

### 集成技术
- **飞书开放平台** - 机器人Webhook
- **企业微信** - 机器人Webhook
- **SMTP** - 邮件发送
- **VirusTotal/AbuseIPDB** - 威胁情报

### 运维技术
- **Docker** - 容器化
- **Docker Compose** - 编排
- **YAML** - 配置管理
- **JSON** - 日志格式

## 📊 预期成果

### 第1周结束
- ✅ 系统能够定时自动拉取数据
- ✅ 系统能够自动触发分析任务
- ✅ 分析结果保存到数据库
- ✅ 基本的配置文件支持

### 第2周结束
- ✅ 发现安全问题自动通知到飞书/企业微信/邮件
- ✅ 所有8种分析器都使用真实威胁情报
- ✅ 完整的配置管理系统
- ✅ 结构化日志系统

### 第3周结束
- ✅ 完整的测试覆盖
- ✅ 监控指标系统
- ✅ Docker部署方案
- ✅ 部署脚本和工具

### 第4周结束
- ✅ 完整的文档（架构、部署、运维）
- ✅ 更多威胁情报提供商
- ✅ 更多数据源连接器
- ✅ 系统可以交付使用

## 🚀 典型使用流程

### 1. 部署阶段
```bash
# 1. 克隆代码
git clone <repo>

# 2. 配置系统
cp config.example.yaml config.yaml
vim config.yaml  # 配置数据源、告警渠道等

# 3. 启动系统
docker-compose up -d

# 4. 初始化数据库
python scripts/init_db.py
```

### 2. 运行阶段（自动化）
```
[定时触发] → [拉取数据] → [执行分析] → [存储结果] → [发送告警]
     ↓            ↓            ↓            ↓            ↓
  Cron配置    数据接入层    分析引擎    数据库存储   通知系统
```

### 3. 告警示例

**飞书通知**:
```
🚨 安全告警

【失陷主机检测】
严重级别: 高
检测时间: 2024-12-31 10:30:00

发现可疑主机:
- IP: 192.168.1.100
- 威胁评分: 0.85
- 威胁类型: C2通信, 恶意软件

建议措施:
1. 立即隔离该主机
2. 检查该主机的进程和网络连接
3. 进行全面的恶意软件扫描

详细报告: [查看详情]
```

**企业微信通知**:
```markdown
## 🚨 安全告警

**失陷主机检测**
- 严重级别: 高
- 检测时间: 2024-12-31 10:30:00

**发现可疑主机**:
- IP: 192.168.1.100
- 威胁评分: 0.85
- 威胁类型: C2通信, 恶意软件

**建议措施**:
1. 立即隔离该主机
2. 检查该主机的进程和网络连接
3. 进行全面的恶意软件扫描
```

## 📈 性能指标

### 预期性能
- **分析延迟**: < 5分钟（从数据拉取到分析完成）
- **告警延迟**: < 1分钟（从发现问题到发送通知）
- **数据吞吐**: 支持每小时分析10万条日志
- **并发任务**: 支持同时运行5个分析任务

### 资源需求
- **CPU**: 4核（推荐）
- **内存**: 8GB（推荐）
- **磁盘**: 100GB（数据存储）
- **网络**: 稳定的互联网连接（威胁情报查询）

## 🔒 安全考虑

1. **API密钥管理**: 使用环境变量，不提交到代码库
2. **敏感数据**: 日志中脱敏处理
3. **数据库**: 使用强密码，限制访问
4. **通知渠道**: 使用HTTPS，验证Webhook签名
5. **权限控制**: 最小权限原则

## 📝 下一步行动

### 立即开始（本周）
1. **设计自动化调度系统**
   - 定义任务调度接口
   - 实现APScheduler集成
   - 实现数据源自动拉取

2. **设计数据库表结构**
   - 分析结果表
   - 告警记录表
   - 任务历史表
   - IOC记录表

3. **实现结果持久化存储**
   - SQLAlchemy ORM模型
   - 存储接口实现
   - 查询API实现

### 后续任务
- 按照TODO.md中的计划逐步实施
- 每周更新进度
- 及时调整优先级

## 📞 联系方式

如有问题或需要调整计划，请随时沟通！

---

最后更新: 2024-12-31
创建者: Claude (Sonnet 4.5)
